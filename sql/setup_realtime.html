
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>תיקון סנכרון זמן אמת (Realtime Fix)</title>
    <style>body{font-family:sans-serif;background:#ecfdf5;padding:40px;color:#064e3b}.container{max-width:800px;margin:0 auto;background:white;padding:30px;border-radius:12px;border:1px solid #6ee7b7;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1)}textarea{width:100%;height:350px;background:#0f172a;color:#34d399;padding:15px;border-radius:8px;direction:ltr;font-family:monospace;font-size:14px}button{background:#059669;color:white;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;margin-top:15px;font-weight:bold;font-size:16px;width:100%}button:hover{background:#047857}h1{margin-top:0}</style>
</head>
<body>
    <div class="container">
        <h1>⚡ הפעלת עדכונים בזמן אמת (Realtime Fix)</h1>
        <p>הבעיה שתיארת נובעת מכך ש-Supabase לא "משדר" שינויים בטבלאות מסוימות כברירת מחדל.</p>
        <p><strong>הוראות:</strong> העתק את הקוד, היכנס ל-SQL Editor ב-Supabase והרץ אותו.</p>
        
        <textarea id="sql" readonly>
BEGIN;

-- 1. Remove tables from publication first to ensure clean slate (avoids duplicates)
-- We ignore errors if they aren't there yet
DROP PUBLICATION IF EXISTS supabase_realtime;
CREATE PUBLICATION supabase_realtime FOR ALL TABLES;

-- Alternatively, if you want to be specific (Safer for heavy production):
-- ALTER PUBLICATION supabase_realtime ADD TABLE classes;
-- ALTER PUBLICATION supabase_realtime ADD TABLE students;
-- ALTER PUBLICATION supabase_realtime ADD TABLE action_logs;
-- ALTER PUBLICATION supabase_realtime ADD TABLE ticker_messages;
-- ALTER PUBLICATION supabase_realtime ADD TABLE app_settings;

-- 2. Set Replica Identity to FULL
-- This ensures that when a row is updated/deleted, the frontend gets the FULL OLD ROW data.
-- Critical for calculating score diffs correctly.
ALTER TABLE classes REPLICA IDENTITY FULL;
ALTER TABLE students REPLICA IDENTITY FULL;
ALTER TABLE action_logs REPLICA IDENTITY FULL;
ALTER TABLE ticker_messages REPLICA IDENTITY FULL;
ALTER TABLE app_settings REPLICA IDENTITY FULL;

-- 3. Verify Publication
-- This query confirms that the tables are tracked.
SELECT * FROM pg_publication_tables WHERE pubname = 'supabase_realtime';

COMMIT;
        </textarea>
        <button onclick="navigator.clipboard.writeText(document.getElementById('sql').value)">העתק קוד SQL</button>
    </div>
</body>
</html>
